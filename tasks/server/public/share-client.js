!function t(e,i,n){function r(o,l){if(!i[o]){if(!e[o]){var h="function"==typeof require&&require;if(!l&&h)return h(o,!0);if(s)return s(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var p=i[o]={exports:{}};e[o][0].call(p.exports,function(t){var i=e[o][1][t];return r(i?i:t)},p,p.exports,t,e,i,n)}return i[o].exports}for(var s="function"==typeof require&&require,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,e,i){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(t){return"function"==typeof t}function s(t){return"number"==typeof t}function o(t){return"object"==typeof t&&null!==t}function l(t){return void 0===t}e.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(t){if(!s(t)||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},n.prototype.emit=function(t){var e,i,n,s,h,c;if(this._events||(this._events={}),"error"===t&&(!this._events.error||o(this._events.error)&&!this._events.error.length)){if(e=arguments[1],e instanceof Error)throw e;var p=new Error('Uncaught, unspecified "error" event. ('+e+")");throw p.context=e,p}if(i=this._events[t],l(i))return!1;if(r(i))switch(arguments.length){case 1:i.call(this);break;case 2:i.call(this,arguments[1]);break;case 3:i.call(this,arguments[1],arguments[2]);break;default:s=Array.prototype.slice.call(arguments,1),i.apply(this,s)}else if(o(i))for(s=Array.prototype.slice.call(arguments,1),c=i.slice(),n=c.length,h=0;h<n;h++)c[h].apply(this,s);return!0},n.prototype.addListener=function(t,e){var i;if(!r(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,r(e.listener)?e.listener:e),this._events[t]?o(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,o(this._events[t])&&!this._events[t].warned&&(i=l(this._maxListeners)?n.defaultMaxListeners:this._maxListeners,i&&i>0&&this._events[t].length>i&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),"function"==typeof console.trace&&console.trace())),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(t,e){function i(){this.removeListener(t,i),n||(n=!0,e.apply(this,arguments))}if(!r(e))throw TypeError("listener must be a function");var n=!1;return i.listener=e,this.on(t,i),this},n.prototype.removeListener=function(t,e){var i,n,s,l;if(!r(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(i=this._events[t],s=i.length,n=-1,i===e||r(i.listener)&&i.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(o(i)){for(l=s;l-- >0;)if(i[l]===e||i[l].listener&&i[l].listener===e){n=l;break}if(n<0)return this;1===i.length?(i.length=0,delete this._events[t]):i.splice(n,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},n.prototype.removeAllListeners=function(t){var e,i;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(i=this._events[t],r(i))this.removeListener(t,i);else if(i)for(;i.length;)this.removeListener(t,i[i.length-1]);return delete this._events[t],this},n.prototype.listeners=function(t){var e;return e=this._events&&this._events[t]?r(this._events[t])?[this._events[t]]:this._events[t].slice():[]},n.prototype.listenerCount=function(t){if(this._events){var e=this._events[t];if(r(e))return 1;if(e)return e.length}return 0},n.listenerCount=function(t,e){return t.listenerCount(e)}},{}],2:[function(t,e,i){"use strict";function n(t){t&&s(this,"message",{configurable:!0,value:t,writable:!0});var e=this.constructor.name;e&&e!==this.name&&s(this,"name",{configurable:!0,value:e,writable:!0}),o(this,this.constructor)}function r(t,e){if(null==e||e===Error)e=n;else if("function"!=typeof e)throw new TypeError("super_ should be a function");var i;if("string"==typeof t)i=t,t=function(){e.apply(this,arguments)},l&&(l(t,i),i=null);else if("function"!=typeof t)throw new TypeError("constructor should be either a string or a function");t.super_=t.super=e;var r={constructor:{configurable:!0,value:t,writable:!0}};return null!=i&&(r.name={configurable:!0,value:i,writable:!0}),t.prototype=Object.create(e.prototype,r),t}var s=Object.defineProperty,o=Error.captureStackTrace;o||(o=function(t){var e=new Error;s(t,"stack",{configurable:!0,get:function(){var t=e.stack;return s(this,"stack",{value:t}),t},set:function(e){s(t,"stack",{configurable:!0,value:e,writable:!0})}})}),n.prototype=Object.create(Error.prototype,{constructor:{configurable:!0,value:n,writable:!0}});var l=function(){function t(t,e){return s(t,"name",{configurable:!0,value:e})}try{var e=function(){};if(t(e,"foo"),"foo"===e.name)return t}catch(t){}}();i=e.exports=r,i.BaseError=n},{}],3:[function(t,e,i){function n(t,e,i,n){var r=function(t,i,n,r){e(n,t,i,"left"),e(r,i,t,"right")},s=t.transformX=function(t,e){i(t),i(e);for(var o=[],l=0;l<e.length;l++){for(var h=e[l],c=[],p=0;p<t.length;){var a=[];if(r(t[p],h,c,a),p++,1!==a.length){if(0===a.length){for(var u=p;u<t.length;u++)n(c,t[u]);h=null;break}for(var f=s(t.slice(p),a),d=0;d<f[0].length;d++)n(c,f[0][d]);for(var v=0;v<f[1].length;v++)n(o,f[1][v]);h=null;break}h=a[0]}null!=h&&n(o,h),t=c}return[t,o]};t.transform=function(t,i,n){if("left"!==n&&"right"!==n)throw new Error("type must be 'left' or 'right'");return 0===i.length?t:1===t.length&&1===i.length?e([],t[0],i[0],n):"left"===n?s(t,i)[0]:s(i,t)[1]}}e.exports=n},{}],4:[function(t,e,i){e.exports={type:t("./json0")}},{"./json0":5}],5:[function(t,e,i){function n(t){t.t="text0";var e={p:t.p.pop()};null!=t.si&&(e.i=t.si),null!=t.sd&&(e.d=t.sd),t.o=[e]}function r(t){t.p.push(t.o[0].p),null!=t.o[0].i&&(t.si=t.o[0].i),null!=t.o[0].d&&(t.sd=t.o[0].d),delete t.t,delete t.o}var s=function(t){return"[object Array]"==Object.prototype.toString.call(t)},o=function(t){return!!t&&t.constructor===Object},l=function(t){return JSON.parse(JSON.stringify(t))},h={name:"json0",uri:"http://sharejs.org/types/JSONv0"},c={};h.registerSubtype=function(t){c[t.name]=t},h.create=function(t){return void 0===t?null:l(t)},h.invertComponent=function(t){var e={p:t.p};return t.t&&c[t.t]&&(e.t=t.t,e.o=c[t.t].invert(t.o)),void 0!==t.si&&(e.sd=t.si),void 0!==t.sd&&(e.si=t.sd),void 0!==t.oi&&(e.od=t.oi),void 0!==t.od&&(e.oi=t.od),void 0!==t.li&&(e.ld=t.li),void 0!==t.ld&&(e.li=t.ld),void 0!==t.na&&(e.na=-t.na),void 0!==t.lm&&(e.lm=t.p[t.p.length-1],e.p=t.p.slice(0,t.p.length-1).concat([t.lm])),e},h.invert=function(t){for(var e=t.slice().reverse(),i=[],n=0;n<e.length;n++)i.push(h.invertComponent(e[n]));return i},h.checkValidOp=function(t){for(var e=0;e<t.length;e++)if(!s(t[e].p))throw new Error("Missing path")},h.checkList=function(t){if(!s(t))throw new Error("Referenced element not a list")},h.checkObj=function(t){if(!o(t))throw new Error("Referenced element not an object (it was "+JSON.stringify(t)+")")},h.apply=function(t,e){h.checkValidOp(e),e=l(e);for(var i={data:t},r=0;r<e.length;r++){var s=e[r];null==s.si&&null==s.sd||n(s);for(var o=null,p=null,a=i,u="data",f=0;f<s.p.length;f++){var d=s.p[f];if(o=a,p=u,a=a[u],u=d,null==o)throw new Error("Path invalid")}if(s.t&&void 0!==s.o&&c[s.t])a[u]=c[s.t].apply(a[u],s.o);else if(void 0!==s.na){if("number"!=typeof a[u])throw new Error("Referenced element not a number");a[u]+=s.na}else if(void 0!==s.li&&void 0!==s.ld)h.checkList(a),a[u]=s.li;else if(void 0!==s.li)h.checkList(a),a.splice(u,0,s.li);else if(void 0!==s.ld)h.checkList(a),a.splice(u,1);else if(void 0!==s.lm){if(h.checkList(a),s.lm!=u){var v=a[u];a.splice(u,1),a.splice(s.lm,0,v)}}else if(void 0!==s.oi)h.checkObj(a),a[u]=s.oi;else{if(void 0===s.od)throw new Error("invalid / missing instruction in op");h.checkObj(a),delete a[u]}}return i.data},h.shatter=function(t){for(var e=[],i=0;i<t.length;i++)e.push([t[i]]);return e},h.incrementalApply=function(t,e,i){for(var n=0;n<e.length;n++){var r=[e[n]];t=h.apply(t,r),i(r,t)}return t};var p=h.pathMatches=function(t,e,i){if(t.length!=e.length)return!1;for(var n=0;n<t.length;n++)if(t[n]!==e[n]&&(!i||n!==t.length-1))return!1;return!0};h.append=function(t,e){if(e=l(e),0===t.length)return void t.push(e);var i=t[t.length-1];if(null==e.si&&null==e.sd||null==i.si&&null==i.sd||(n(e),n(i)),p(e.p,i.p))if(e.t&&i.t&&e.t===i.t&&c[e.t]){if(i.o=c[e.t].compose(i.o,e.o),null!=e.si||null!=e.sd){for(var s=e.p,o=0;o<i.o.length-1;o++)e.o=[i.o.pop()],e.p=s.slice(),r(e),t.push(e);r(i)}}else null!=i.na&&null!=e.na?t[t.length-1]={p:i.p,na:i.na+e.na}:void 0!==i.li&&void 0===e.li&&e.ld===i.li?void 0!==i.ld?delete i.li:t.pop():void 0!==i.od&&void 0===i.oi&&void 0!==e.oi&&void 0===e.od?i.oi=e.oi:void 0!==i.oi&&void 0!==e.od?void 0!==e.oi?i.oi=e.oi:void 0!==i.od?delete i.oi:t.pop():void 0!==e.lm&&e.p[e.p.length-1]===e.lm||t.push(e);else null==e.si&&null==e.sd||null==i.si&&null==i.sd||(r(e),r(i)),t.push(e)},h.compose=function(t,e){h.checkValidOp(t),h.checkValidOp(e);for(var i=l(t),n=0;n<e.length;n++)h.append(i,e[n]);return i},h.normalize=function(t){var e=[];t=s(t)?t:[t];for(var i=0;i<t.length;i++){var n=t[i];null==n.p&&(n.p=[]),h.append(e,n)}return e},h.commonLengthForOps=function(t,e){var i=t.p.length,n=e.p.length;if((null!=t.na||t.t)&&i++,(null!=e.na||e.t)&&n++,0===i)return-1;if(0===n)return null;i--,n--;for(var r=0;r<i;r++){var s=t.p[r];if(r>=n||s!==e.p[r])return null}return i},h.canOpAffectPath=function(t,e){return null!=h.commonLengthForOps({p:e},t)},h.transformComponent=function(t,e,i,s){e=l(e);var o=h.commonLengthForOps(i,e),p=h.commonLengthForOps(e,i),a=e.p.length,u=i.p.length;if((null!=e.na||e.t)&&a++,(null!=i.na||i.t)&&u++,null!=p&&u>a&&e.p[p]==i.p[p])if(void 0!==e.ld){var f=l(i);f.p=f.p.slice(a),e.ld=h.apply(l(e.ld),[f])}else if(void 0!==e.od){var f=l(i);f.p=f.p.slice(a),e.od=h.apply(l(e.od),[f])}if(null!=o){var d=a==u,f=i;if(null==e.si&&null==e.sd||null==i.si&&null==i.sd||(n(e),f=l(i),n(f)),f.t&&c[f.t]){if(e.t&&e.t===f.t){var v=c[e.t].transform(e.o,f.o,s);if(v.length>0)if(null!=e.si||null!=e.sd)for(var g=e.p,y=0;y<v.length;y++)e.o=[v[y]],e.p=g.slice(),r(e),h.append(t,e);else e.o=v,h.append(t,e);return t}}else if(void 0!==i.na);else if(void 0!==i.li&&void 0!==i.ld){if(i.p[o]===e.p[o]){if(!d)return t;if(void 0!==e.ld){if(void 0===e.li||"left"!==s)return t;e.ld=l(i.li)}}}else if(void 0!==i.li)void 0!==e.li&&void 0===e.ld&&d&&e.p[o]===i.p[o]?"right"===s&&e.p[o]++:i.p[o]<=e.p[o]&&e.p[o]++,void 0!==e.lm&&d&&i.p[o]<=e.lm&&e.lm++;else if(void 0!==i.ld){if(void 0!==e.lm&&d){if(i.p[o]===e.p[o])return t;var g=i.p[o],m=e.p[o],b=e.lm;(g<b||g===b&&m<b)&&e.lm--}if(i.p[o]<e.p[o])e.p[o]--;else if(i.p[o]===e.p[o]){if(u<a)return t;if(void 0!==e.ld){if(void 0===e.li)return t;delete e.ld}}}else if(void 0!==i.lm)if(void 0!==e.lm&&a===u){var m=e.p[o],b=e.lm,_=i.p[o],w=i.lm;if(_!==w)if(m===_){if("left"!==s)return t;e.p[o]=w,m===b&&(e.lm=w)}else m>_&&e.p[o]--,m>w?e.p[o]++:m===w&&_>w&&(e.p[o]++,m===b&&e.lm++),b>_?e.lm--:b===_&&b>m&&e.lm--,b>w?e.lm++:b===w&&(w>_&&b>m||w<_&&b<m?"right"===s&&e.lm++:b>m?e.lm++:b===_&&e.lm--)}else if(void 0!==e.li&&void 0===e.ld&&d){var m=i.p[o],b=i.lm;g=e.p[o],g>m&&e.p[o]--,g>b&&e.p[o]++}else{var m=i.p[o],b=i.lm;g=e.p[o],g===m?e.p[o]=b:(g>m&&e.p[o]--,g>b?e.p[o]++:g===b&&m>b&&e.p[o]++)}else if(void 0!==i.oi&&void 0!==i.od){if(e.p[o]===i.p[o]){if(void 0===e.oi||!d)return t;if("right"===s)return t;e.od=i.oi}}else if(void 0!==i.oi){if(void 0!==e.oi&&e.p[o]===i.p[o]){if("left"!==s)return t;h.append(t,{p:e.p,od:i.oi})}}else if(void 0!==i.od&&e.p[o]==i.p[o]){if(!d)return t;if(void 0===e.oi)return t;delete e.od}}return h.append(t,e),t},t("./bootstrapTransform")(h,h.transformComponent,h.checkValidOp,h.append);var a=t("./text0");h.registerSubtype(a),e.exports=h},{"./bootstrapTransform":3,"./text0":6}],6:[function(t,e,i){var n=e.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(t){if(null!=t&&"string"!=typeof t)throw new Error("Initial data must be a string");return t||""}},r=function(t,e,i){return t.slice(0,e)+i+t.slice(e)},s=function(t){if("number"!=typeof t.p)throw new Error("component missing position field");if("string"==typeof t.i==("string"==typeof t.d))throw new Error("component needs an i or d field");if(t.p<0)throw new Error("position cannot be negative")},o=function(t){for(var e=0;e<t.length;e++)s(t[e])};n.apply=function(t,e){var i;o(e);for(var n=0;n<e.length;n++){var s=e[n];if(null!=s.i)t=r(t,s.p,s.i);else{if(i=t.slice(s.p,s.p+s.d.length),s.d!==i)throw new Error("Delete component '"+s.d+"' does not match deleted text '"+i+"'");t=t.slice(0,s.p)+t.slice(s.p+s.d.length)}}return t};var l=n._append=function(t,e){if(""!==e.i&&""!==e.d)if(0===t.length)t.push(e);else{var i=t[t.length-1];null!=i.i&&null!=e.i&&i.p<=e.p&&e.p<=i.p+i.i.length?t[t.length-1]={i:r(i.i,e.p-i.p,e.i),p:i.p}:null!=i.d&&null!=e.d&&e.p<=i.p&&i.p<=e.p+e.d.length?t[t.length-1]={d:r(e.d,i.p-e.p,i.d),p:e.p}:t.push(e)}};n.compose=function(t,e){o(t),o(e);for(var i=t.slice(),n=0;n<e.length;n++)l(i,e[n]);return i},n.normalize=function(t){var e=[];null==t.i&&null==t.p||(t=[t]);for(var i=0;i<t.length;i++){var n=t[i];null==n.p&&(n.p=0),l(e,n)}return e};var h=function(t,e,i){return null!=e.i?e.p<t||e.p===t&&i?t+e.i.length:t:t<=e.p?t:t<=e.p+e.d.length?e.p:t-e.d.length};n.transformCursor=function(t,e,i){for(var n="right"===i,r=0;r<e.length;r++)t=h(t,e[r],n);return t};var c=n._tc=function(t,e,i,n){if(s(e),s(i),null!=e.i)l(t,{i:e.i,p:h(e.p,i,"right"===n)});else if(null!=i.i){var r=e.d;e.p<i.p&&(l(t,{d:r.slice(0,i.p-e.p),p:e.p}),r=r.slice(i.p-e.p)),""!==r&&l(t,{d:r,p:e.p+i.i.length})}else if(e.p>=i.p+i.d.length)l(t,{d:e.d,p:e.p-i.d.length});else if(e.p+e.d.length<=i.p)l(t,e);else{var o={d:"",p:e.p};e.p<i.p&&(o.d=e.d.slice(0,i.p-e.p)),e.p+e.d.length>i.p+i.d.length&&(o.d+=e.d.slice(i.p+i.d.length-e.p));var c=Math.max(e.p,i.p),p=Math.min(e.p+e.d.length,i.p+i.d.length),a=e.d.slice(c-e.p,p-e.p),u=i.d.slice(c-i.p,p-i.p);if(a!==u)throw new Error("Delete ops delete different text in the same region of the document");""!==o.d&&(o.p=h(o.p,i),l(t,o))}return t},p=function(t){return null!=t.i?{d:t.i,p:t.p}:{i:t.d,p:t.p}};n.invert=function(t){t=t.slice().reverse();for(var e=0;e<t.length;e++)t[e]=p(t[e]);return t},t("./bootstrapTransform")(n,c,o,l)},{"./bootstrapTransform":3}],7:[function(t,e,i){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function s(t){if(a===setTimeout)return setTimeout(t,0);if((a===n||!a)&&setTimeout)return a=setTimeout,setTimeout(t,0);try{return a(t,0)}catch(e){try{return a.call(null,t,0)}catch(e){return a.call(this,t,0)}}}function o(t){if(u===clearTimeout)return clearTimeout(t);if((u===r||!u)&&clearTimeout)return u=clearTimeout,clearTimeout(t);try{return u(t)}catch(e){try{return u.call(null,t)}catch(e){return u.call(this,t)}}}function l(){g&&d&&(g=!1,d.length?v=d.concat(v):y=-1,v.length&&h())}function h(){if(!g){var t=s(l);g=!0;for(var e=v.length;e;){for(d=v,v=[];++y<e;)d&&d[y].run();y=-1,e=v.length}d=null,g=!1,o(t)}}function c(t,e){this.fun=t,this.array=e}function p(){}var a,u,f=e.exports={};!function(){try{a="function"==typeof setTimeout?setTimeout:n}catch(t){a=n}try{u="function"==typeof clearTimeout?clearTimeout:r}catch(t){u=r}}();var d,v=[],g=!1,y=-1;f.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];v.push(new c(t,e)),1!==v.length||g||s(h)},c.prototype.run=function(){this.fun.apply(null,this.array)},f.title="browser",f.browser=!0,f.env={},f.argv=[],f.version="",f.versions={},f.on=p,f.addListener=p,f.once=p,f.off=p,f.removeListener=p,f.removeAllListeners=p,f.emit=p,f.binding=function(t){throw new Error("process.binding is not supported")},f.cwd=function(){return"/"},f.chdir=function(t){throw new Error("process.chdir is not supported")},f.umask=function(){return 0}},{}],8:[function(t,e,i){(function(i){function n(t){h.EventEmitter.call(this),this.collections={},this.nextQueryId=1,this.queries={},this.seq=1,this.id=null,this.agent=null,this.debug=!1,this.bindToSocket(t)}function r(t){return t.hasPending()}function s(t){return t.hasWritePending()}var o=t("./doc"),l=t("./query"),h=t("../emitter"),c=t("../error"),p=t("../types"),a=t("../util");e.exports=n,h.mixin(n),n.prototype.bindToSocket=function(t){this.socket&&(this.socket.close(),this.socket.onmessage=null,this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null),this.socket=t,this.state=0===t.readyState||1===t.readyState?"connecting":"disconnected",this.canSend=!1;var e=this;t.onmessage=function(t){try{var n="string"==typeof t.data?JSON.parse(t.data):t.data}catch(e){return void console.warn("Failed to parse message",t)}e.debug&&console.log("RECV",JSON.stringify(n));var r={data:n};if(e.emit("receive",r),r.data)try{e.handleMessage(r.data)}catch(t){i.nextTick(function(){e.emit("error",t)})}},t.onopen=function(){e._setState("connecting")},t.onerror=function(t){e.emit("connection error",t)},t.onclose=function(t){"closed"===t||"Closed"===t?e._setState("closed",t):"stopped"===t||"Stopped by server"===t?e._setState("stopped",t):e._setState("disconnected",t)}},n.prototype.handleMessage=function(t){var e=null;switch(t.error&&(e=new Error(t.error.message),e.code=t.error.code,e.data=t,delete t.error),t.a){case"init":return 1!==t.protocol?(e=new c(4019,"Invalid protocol version"),this.emit("error",e)):p.map[t.type]!==p.defaultType?(e=new c(4020,"Invalid default type"),this.emit("error",e)):"string"!=typeof t.id?(e=new c(4021,"Invalid client id"),this.emit("error",e)):(this.id=t.id,void this._setState("connected"));case"qf":var i=this.queries[t.id];return void(i&&i._handleFetch(e,t.data,t.extra));case"qs":var i=this.queries[t.id];return void(i&&i._handleSubscribe(e,t.data,t.extra));case"qu":return;case"q":var i=this.queries[t.id];if(!i)return;return e?i._handleError(e):(t.diff&&i._handleDiff(t.diff),void(t.hasOwnProperty("extra")&&i._handleExtra(t.extra)));case"bf":return this._handleBulkMessage(t,"_handleFetch");case"bs":return this._handleBulkMessage(t,"_handleSubscribe");case"bu":return this._handleBulkMessage(t,"_handleUnsubscribe");case"f":var n=this.getExisting(t.c,t.d);return void(n&&n._handleFetch(e,t.data));case"s":var n=this.getExisting(t.c,t.d);return void(n&&n._handleSubscribe(e,t.data));case"u":var n=this.getExisting(t.c,t.d);return void(n&&n._handleUnsubscribe(e));case"op":var n=this.getExisting(t.c,t.d);return void(n&&n._handleOp(e,t));default:console.warn("Ignorning unrecognized message",t)}},n.prototype._handleBulkMessage=function(t,e){if(t.data)for(var i in t.data){var n=this.getExisting(t.c,i);n&&n[e](t.error,t.data[i])}else if(Array.isArray(t.b))for(var r=0;r<t.b.length;r++){var i=t.b[r],n=this.getExisting(t.c,i);n&&n[e](t.error)}else if(t.b)for(var i in t.b){var n=this.getExisting(t.c,i);n&&n[e](t.error)}else console.error("Invalid bulk message",t)},n.prototype._reset=function(){this.seq=1,this.id=null,this.agent=null},n.prototype._setState=function(t,e){if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state&&"stopped"!==this.state&&"closed"!==this.state||"connected"===t&&"connecting"!==this.state){var i=new c(5007,"Cannot transition directly from "+this.state+" to "+t);return this.emit("error",i)}this.state=t,this.canSend="connected"===t,"disconnected"!==t&&"stopped"!==t&&"closed"!==t||this._reset(),this.startBulk();for(var n in this.queries){var r=this.queries[n];r._onConnectionStateChanged()}for(var s in this.collections){var o=this.collections[s];for(var n in o)o[n]._onConnectionStateChanged()}this.endBulk(),this.emit(t,e),this.emit("state",t,e)}},n.prototype.startBulk=function(){this.bulk||(this.bulk={})},n.prototype.endBulk=function(){if(this.bulk)for(var t in this.bulk){var e=this.bulk[t];this._sendBulk("f",t,e.f),this._sendBulk("s",t,e.s),this._sendBulk("u",t,e.u)}this.bulk=null},n.prototype._sendBulk=function(t,e,i){if(i){var n,r=[],s={},o=0;for(var l in i){var h=i[l];null==h?r.push(l):(s[l]=h,n=l,o++)}if(1===r.length){var l=r[0];this.send({a:t,c:e,d:l})}else r.length&&this.send({a:"b"+t,c:e,b:r});if(1===o){var c=s[n];this.send({a:t,c:e,d:n,v:c})}else o&&this.send({a:"b"+t,c:e,b:s})}},n.prototype._sendAction=function(t,e,i){if(this._addDoc(e),this.bulk){var n=this.bulk[e.collection]||(this.bulk[e.collection]={}),r=n[t]||(n[t]={}),s=r.hasOwnProperty(e.id);return r[e.id]=i,s}var o={a:t,c:e.collection,d:e.id,v:i};this.send(o)},n.prototype.sendFetch=function(t){return this._sendAction("f",t,t.version)},n.prototype.sendSubscribe=function(t){return this._sendAction("s",t,t.version)},n.prototype.sendUnsubscribe=function(t){return this._sendAction("u",t)},n.prototype.sendOp=function(t,e){this._addDoc(t);var i={a:"op",c:t.collection,d:t.id,v:t.version,src:e.src,seq:e.seq};e.op&&(i.op=e.op),e.create&&(i.create=e.create),e.del&&(i.del=e.del),this.send(i)},n.prototype.send=function(t){this.debug&&console.log("SEND",JSON.stringify(t)),this.emit("send",t),this.socket.send(JSON.stringify(t))},n.prototype.close=function(){this.socket.close()},n.prototype.getExisting=function(t,e){if(this.collections[t])return this.collections[t][e]},n.prototype.get=function(t,e){var i=this.collections[t]||(this.collections[t]={}),n=i[e];return n||(n=i[e]=new o(this,t,e),this.emit("doc",n)),n},n.prototype._destroyDoc=function(t){var e=this.collections[t.collection];e&&(delete e[t.id],a.hasKeys(e)||delete this.collections[t.collection])},n.prototype._addDoc=function(t){var e=this.collections[t.collection];e||(e=this.collections[t.collection]={}),e[t.id]!==t&&(e[t.id]=t)},n.prototype._createQuery=function(t,e,i,n,r){var s=this.nextQueryId++,o=new l(t,this,s,e,i,n,r);return this.queries[s]=o,o.send(),o},n.prototype._destroyQuery=function(t){delete this.queries[t.id]},n.prototype.createFetchQuery=function(t,e,i,n){return this._createQuery("qf",t,e,i,n)},n.prototype.createSubscribeQuery=function(t,e,i,n){return this._createQuery("qs",t,e,i,n)},n.prototype.hasPending=function(){return!(!this._firstDoc(r)&&!this._firstQuery(r))},n.prototype.hasWritePending=function(){return!!this._firstDoc(s)},n.prototype.whenNothingPending=function(t){var e=this._firstDoc(r);if(e)return void e.once("nothing pending",this._nothingPendingRetry(t));var n=this._firstQuery(r);return n?void n.once("ready",this._nothingPendingRetry(t)):void i.nextTick(t)},n.prototype._nothingPendingRetry=function(t){var e=this;return function(){i.nextTick(function(){e.whenNothingPending(t)})}},n.prototype._firstDoc=function(t){for(var e in this.collections){var i=this.collections[e];for(var n in i){var r=i[n];if(t(r))return r}}},n.prototype._firstQuery=function(t){for(var e in this.queries){var i=this.queries[e];if(t(i))return i}}}).call(this,t("_process"))},{"../emitter":12,"../error":13,"../types":14,"../util":15,"./doc":9,"./query":11,_process:7}],9:[function(t,e,i){(function(i){function n(t,e,i){h.EventEmitter.call(this),this.connection=t,this.collection=e,this.id=i,this.version=null,this.type=null,this.data=void 0,this.inflightFetch=[],this.inflightSubscribe=[],this.inflightUnsubscribe=[],this.pendingFetch=[],this.subscribed=!1,this.wantSubscribe=!1,this.inflightOp=null,this.pendingOps=[],this.type=null,this.applyStack=null,this.preventCompose=!1}function r(t,e,i){if(e){var n=t.pop();t.push(function(t){n&&n(t),i&&i(t)})}else t.push(i)}function s(t){delete t.op,delete t.create,delete t.del}function o(t,e){if(t.del)return s(e);if(e.del)return new c(4017,"Document was deleted");if(e.create)return new c(4018,"Document alredy created");if(e.op){if(t.create)return new c(4018,"Document already created");if(t.type.transformX){var i=t.type.transformX(t.op,e.op);t.op=i[0],e.op=i[1]}else{var n=t.type.transform(t.op,e.op,"left"),r=t.type.transform(e.op,t.op,"right");t.op=n,e.op=r}}}function l(t,e){for(var i=!1,n=0;n<t.length;n++){var r=t[n];r&&(r(e),i=!0)}return i}var h=t("../emitter"),c=t("../error"),p=t("../types");e.exports=n,h.mixin(n),n.prototype.destroy=function(t){var e=this;e.whenNothingPending(function(){return e.connection._destroyDoc(e),e.wantSubscribe?e.unsubscribe(t):void(t&&t())})},n.prototype._setType=function(t){if("string"==typeof t&&(t=p.map[t]),t)this.type=t;else{if(null!==t){var e=new c(4008,"Missing type "+t);return this.emit("error",e)}this.type=t,this.data=void 0}},n.prototype.ingestSnapshot=function(t,e){if(!t)return e&&e();if("number"!=typeof t.v){var i=new c(5008,"Missing version in ingested snapshot. "+this.collection+"."+this.id);return e?e(i):this.emit("error",i)}if(this.type||this.hasWritePending()){if(null==this.version){if(this.hasWritePending())return e&&this.once("no write pending",e);var i=new c(5009,"Cannot ingest snapshot in doc with null version. "+this.collection+"."+this.id);return e?e(i):this.emit("error",i)}return t.v>this.version?this.fetch(e):e&&e()}if(this.version>t.v)return e&&e();this.version=t.v;var n=void 0===t.type?p.defaultType:t.type;this._setType(n),this.data=this.type&&this.type.deserialize?this.type.deserialize(t.data):t.data,this.emit("load"),e&&e()},n.prototype.whenNothingPending=function(t){return this.hasPending()?void this.once("nothing pending",t):void t()},n.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe.length||this.inflightUnsubscribe.length||this.pendingFetch.length)},n.prototype.hasWritePending=function(){return!(!this.inflightOp&&!this.pendingOps.length)},n.prototype._emitNothingPending=function(){this.hasWritePending()||(this.emit("no write pending"),this.hasPending()||this.emit("nothing pending"))},n.prototype._emitResponseError=function(t,e){return e?(e(t),void this._emitNothingPending()):(this._emitNothingPending(),void this.emit("error",t))},n.prototype._handleFetch=function(t,e){var i=this.inflightFetch.shift();return t?this._emitResponseError(t,i):(this.ingestSnapshot(e,i),void this._emitNothingPending())},n.prototype._handleSubscribe=function(t,e){var i=this.inflightSubscribe.shift();return t?this._emitResponseError(t,i):(this.wantSubscribe&&(this.subscribed=!0),this.ingestSnapshot(e,i),void this._emitNothingPending())},n.prototype._handleUnsubscribe=function(t){var e=this.inflightUnsubscribe.shift();return t?this._emitResponseError(t,e):(e&&e(),void this._emitNothingPending())},n.prototype._handleOp=function(t,e){if(t)return this.inflightOp?(4002===t.code&&(t=null),this._rollback(t)):this.emit("error",t);if(this.inflightOp&&e.src===this.inflightOp.src&&e.seq===this.inflightOp.seq)return void this._opAcknowledged(e);if(null==this.version||e.v>this.version)return void this.fetch();if(!(e.v<this.version)){if(this.inflightOp){var i=o(this.inflightOp,e);if(i)return this._hardRollback(i)}for(var n=0;n<this.pendingOps.length;n++){var i=o(this.pendingOps[n],e);if(i)return this._hardRollback(i)}this.version++,this._otApply(e,!1)}},n.prototype._onConnectionStateChanged=function(){if(this.connection.canSend)this.flush(),this._resubscribe();else if(this.inflightOp&&(this.pendingOps.unshift(this.inflightOp),this.inflightOp=null),this.subscribed=!1,(this.inflightFetch.length||this.inflightSubscribe.length)&&(this.pendingFetch=this.pendingFetch.concat(this.inflightFetch,this.inflightSubscribe),this.inflightFetch.length=0,this.inflightSubscribe.length=0),this.inflightUnsubscribe.length){var t=this.inflightUnsubscribe;this.inflightUnsubscribe=[],l(t)}},n.prototype._resubscribe=function(){var t=this.pendingFetch;return this.pendingFetch=[],this.wantSubscribe?t.length?void this.subscribe(function(e){l(t,e)}):void this.subscribe():void(t.length&&this.fetch(function(e){l(t,e)}))},n.prototype.fetch=function(t){if(this.connection.canSend){var e=this.connection.sendFetch(this);return void r(this.inflightFetch,e,t)}this.pendingFetch.push(t)},n.prototype.subscribe=function(t){if(this.wantSubscribe=!0,this.connection.canSend){var e=this.connection.sendSubscribe(this);return void r(this.inflightSubscribe,e,t)}this.pendingFetch.push(t)},n.prototype.unsubscribe=function(t){if(this.wantSubscribe=!1,this.subscribed=!1,this.connection.canSend){var e=this.connection.sendUnsubscribe(this);return void r(this.inflightUnsubscribe,e,t)}t&&i.nextTick(t)},n.prototype.flush=function(){this.connection.canSend&&!this.inflightOp&&!this.paused&&this.pendingOps.length&&this._sendOp()},n.prototype._otApply=function(t,e){if(t.op){if(!this.type){var i=new c(4015,"Cannot apply op to uncreated document. "+this.collection+"."+this.id);return this.emit("error",i)}if(!e&&this.type===p.defaultType&&t.op.length>1){this.applyStack||(this.applyStack=[]);for(var n=this.applyStack.length,r=0;r<t.op.length;r++){for(var s=t.op[r],l={op:[s]},h=n;h<this.applyStack.length;h++){var a=o(this.applyStack[h],l);if(a)return this._hardRollback(a)}this.emit("before op",l.op,e),this.data=this.type.apply(this.data,l.op),this.emit("op",l.op,e)}return void this._popApplyStack(n)}return this.emit("before op",t.op,e),this.data=this.type.apply(this.data,t.op),void this.emit("op",t.op,e)}if(t.create)return this._setType(t.create.type),this.data=this.type.deserialize?this.type.createDeserialized?this.type.createDeserialized(t.create.data):this.type.deserialize(this.type.create(t.create.data)):this.type.create(t.create.data),void this.emit("create",e);if(t.del){var u=this.data;return this._setType(null),void this.emit("del",u,e)}},n.prototype._sendOp=function(){var t=this.connection.id;if(t){this.inflightOp||(this.inflightOp=this.pendingOps.shift());var e=this.inflightOp;if(!e){var i=new c(5010,"No op to send on call to _sendOp");return this.emit("error",i)}e.sentAt=Date.now(),e.retries=null==e.retries?0:e.retries+1,null==e.seq&&(e.seq=this.connection.seq++),this.connection.sendOp(this,e),null==e.src&&(e.src=t)}},n.prototype._submit=function(t,e,n){if(e||(e=!0),t.op){if(!this.type){var r=new c(4015,"Cannot submit op. Document has not been created. "+this.collection+"."+this.id);return n?n(r):this.emit("error",r)}this.type.normalize&&(t.op=this.type.normalize(t.op))}this._pushOp(t,n),this._otApply(t,e);var s=this;i.nextTick(function(){s.flush()})},n.prototype._pushOp=function(t,e){if(this.applyStack)this.applyStack.push(t);else{var i=this._tryCompose(t);if(i)return void i.callbacks.push(e)}t.type=this.type,t.callbacks=[e],this.pendingOps.push(t)},n.prototype._popApplyStack=function(t){if(t>0)return void(this.applyStack.length=t);var e=this.applyStack[0];if(this.applyStack=null,e){var i=this.pendingOps.indexOf(e);if(i!==-1)for(var n=this.pendingOps.splice(i),i=0;i<n.length;i++){var e=n[i],r=this._tryCompose(e);r?r.callbacks=r.callbacks.concat(e.callbacks):this.pendingOps.push(e)}}},n.prototype._tryCompose=function(t){if(!this.preventCompose){var e=this.pendingOps[this.pendingOps.length-1];if(e)return e.create&&t.op?(e.create.data=this.type.apply(e.create.data,t.op),e):e.op&&t.op&&this.type.compose?(e.op=this.type.compose(e.op,t.op),e):void 0}},n.prototype.submitOp=function(t,e,i){"function"==typeof e&&(i=e,e=null);var n={op:t},r=e&&e.source;this._submit(n,r,i)},n.prototype.create=function(t,e,i,n){if("function"==typeof e?(n=e,i=null,e=null):"function"==typeof i&&(n=i,i=null),e||(e=p.defaultType.uri),this.type){var r=new c(4016,"Document already exists");return n?n(r):this.emit("error",r)}var s={create:{type:e,data:t}},o=i&&i.source;this._submit(s,o,n)},n.prototype.del=function(t,e){if("function"==typeof t&&(e=t,t=null),!this.type){var i=new c(4015,"Document does not exist");return e?e(i):this.emit("error",i)}var n={del:!0},r=t&&t.source;this._submit(n,r,e)},n.prototype.pause=function(){this.paused=!0},n.prototype.resume=function(){this.paused=!1,this.flush()},n.prototype._opAcknowledged=function(t){
if(this.inflightOp.create)this.version=t.v;else if(t.v!==this.version)return console.warn("Invalid version from server. Expected: "+this.version+" Received: "+t.v,t),this.fetch();this.version++,this._clearInflightOp()},n.prototype._rollback=function(t){var e=this.inflightOp;if(e.op&&e.type.invert){e.op=e.type.invert(e.op);for(var i=0;i<this.pendingOps.length;i++){var n=o(this.pendingOps[i],e);if(n)return this._hardRollback(n)}return this._otApply(e,!1),void this._clearInflightOp(t)}this._hardRollback(t)},n.prototype._hardRollback=function(t){var e=this.inflightOp,i=this.pendingOps;this._setType(null),this.version=null,this.inflightOp=null,this.pendingOps=[];var n=this;this.fetch(function(){for(var r=e&&l(e.callbacks,t),s=0;s<i.length;s++)l(i[s].callbacks,t);if(t&&!r)return n.emit("error",t)})},n.prototype._clearInflightOp=function(t){var e=l(this.inflightOp.callbacks,t);if(this.inflightOp=null,this.flush(),this._emitNothingPending(),t&&!e)return this.emit("error",t)}}).call(this,t("_process"))},{"../emitter":12,"../error":13,"../types":14,_process:7}],10:[function(t,e,i){i.Connection=t("./connection"),i.Doc=t("./doc"),i.Error=t("../error"),i.Query=t("./query"),i.types=t("../types")},{"../error":13,"../types":14,"./connection":8,"./doc":9,"./query":11}],11:[function(t,e,i){(function(i){function n(t,e,i,n,s,o,l){r.EventEmitter.call(this),this.action=t,this.connection=e,this.id=i,this.collection=n,this.query=s,this.results=null,o&&o.results&&(this.results=o.results,delete o.results),this.extra=void 0,this.options=o,this.callback=l,this.ready=!1,this.sent=!1}var r=t("../emitter");e.exports=n,r.mixin(n),n.prototype.hasPending=function(){return!this.ready},n.prototype.send=function(){if(this.connection.canSend){var t={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options&&(t.o=this.options),this.results){for(var e=[],i=0;i<this.results.length;i++){var n=this.results[i];e.push([n.id,n.version])}t.r=e}this.connection.send(t),this.sent=!0}},n.prototype.destroy=function(t){this.connection.canSend&&"qs"===this.action&&this.connection.send({a:"qu",id:this.id}),this.connection._destroyQuery(this),t&&i.nextTick(t)},n.prototype._onConnectionStateChanged=function(){this.connection.canSend&&!this.sent?this.send():this.sent=!1},n.prototype._handleFetch=function(t,e,i){this.connection._destroyQuery(this),this._handleResponse(t,e,i)},n.prototype._handleSubscribe=function(t,e,i){this._handleResponse(t,e,i)},n.prototype._handleResponse=function(t,e,i){var n=this.callback;if(this.callback=null,t)return this._finishResponse(t,n);if(!e)return this._finishResponse(null,n);var r=this,s=1,o=function(t){return t?r._finishResponse(t,n):void(--s||r._finishResponse(null,n))};if(Array.isArray(e))s+=e.length,this.results=this._ingestSnapshots(e,o),this.extra=i;else for(var l in e){s++;var h=e[l],c=this.connection.get(h.c||this.collection,l);c.ingestSnapshot(h,o)}o()},n.prototype._ingestSnapshots=function(t,e){for(var i=[],n=0;n<t.length;n++){var r=t[n],s=this.connection.get(r.c||this.collection,r.d);s.ingestSnapshot(r,e),i.push(s)}return i},n.prototype._finishResponse=function(t,e){return this.emit("ready"),this.ready=!0,t?(this.connection._destroyQuery(this),e?e(t):this.emit("error",t)):void(e&&e(null,this.results,this.extra))},n.prototype._handleError=function(t){this.emit("error",t)},n.prototype._handleDiff=function(t){for(var e=0;e<t.length;e++){var i=t[e];"insert"===i.type&&(i.values=this._ingestSnapshots(i.values))}for(var e=0;e<t.length;e++){var i=t[e];switch(i.type){case"insert":var n=i.values;Array.prototype.splice.apply(this.results,[i.index,0].concat(n)),this.emit("insert",n,i.index);break;case"remove":var r=i.howMany||1,s=this.results.splice(i.index,r);this.emit("remove",s,i.index);break;case"move":var r=i.howMany||1,o=this.results.splice(i.from,r);Array.prototype.splice.apply(this.results,[i.to,0].concat(o)),this.emit("move",o,i.from,i.to)}}this.emit("changed",this.results)},n.prototype._handleExtra=function(t){this.extra=t,this.emit("extra",t)}}).call(this,t("_process"))},{"../emitter":12,_process:7}],12:[function(t,e,i){function n(t){for(var e in r.prototype)t.prototype[e]=r.prototype[e]}var r=t("events").EventEmitter;i.EventEmitter=r,i.mixin=n},{events:1}],13:[function(t,e,i){function n(t,e){n.super.call(this,e),this.code=t}var r=t("make-error");r(n),e.exports=n},{"make-error":2}],14:[function(t,e,i){i.defaultType=t("ot-json0").type,i.map={},i.register=function(t){t.name&&(i.map[t.name]=t),t.uri&&(i.map[t.uri]=t)},i.register(i.defaultType)},{"ot-json0":4}],15:[function(t,e,i){function n(){}i.doNothing=n,i.hasKeys=function(t){for(var e in t)return!0;return!1}},{}],16:[function(t,e,i){window.sharedb=t("../../../node_modules/sharedb/lib/client")},{"../../../node_modules/sharedb/lib/client":10}]},{},[16]);